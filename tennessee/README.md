# tennessee

## Overview
This is a simple Kubernetes application that simulates network connectivity between three namespaces running on the same cluster. The namespaces are named Nashville, Memphis and Knoxville. Memphis and Knoxville are sibling cities. Nashville is the state capital. The sibling cities have a dependency on the capital.

## Simulated Cloud, Region & Account
The tags 'sim-cloud', 'sim-region' and 'sim-account' are used for simulation purposes. This allows us to simulate multiple clouds, regions and accounts within our single cluster. To accomplish this each deployment.yaml is composed of multiple deployments with these aforementioned tags. For example a podset named frontend will actually be named frontend1, frontend2, frontend...N.

## Network Flows

### City (Memphis & Knoxville)
A city is composed of a frontend and a backend. The frontend communicates with the backend and the backend communicates with the database running in Nashville. No other flows should be permitted. For clarification the frontend for a given city should only communicate with the backed located in the same city. Frontends should not communicate with each other. Backends should not originate connections to anywhere except the database in Nashville.

### Capital (Nashville)
Nashville simulates a database cluster. It has a single deployment called database. Database podsets communicate with other database podsets and accept inbound from city backends.

## Policy

### Infrastructure
A policy is included that will permit any workload running on the cluster to access the cluster DNS (Kube DNS). This demonstrates how infrastructure policies need only be created once and then inherited by new applications.

### SecOPS / Org
A policy is included that will restrict flows from sim-account=10 to sim-account=30. This demonstrates how the SecOPS team can create policy that is inherited by children and can not be overridden.

### Application
Policy configuration for each namespace is provided. The configuration for Memphis and Knoxville is virtually identical.

## Rouge Traffic
Rogue traffic can be generated by running the script or scripts in the directory tennessee/k8s/memphis/rogue or tennessee/k8s/knoxville/rogue.

## Deployment

### Steps
1. Clone this repo
2. Change into the directory tennessee/prisma
3. Set the variables CLOUD, GROUP and TENANT in the file Makefile
4. Run make
5. If the namespaces do not already exist in prisma create them with ./create-ns.sh
6. Install the policy with ./create-policy.sh
7. Change into the directory tennessee/k8s
8. Deploy with the command ./deploys.sh

Note that some policies may be disabled initially.

### Example
```bash
git pull https://github.com/aporeto-se/k8s-simple-apps.git
cd k8s-simple-apps/tennessee/prisma
make
./create-ns.sh
./create-policy.sh
cd ../k8s
./deploy.sh
```

### Notes
1. The search/filter capability in the UI can be used to observe this demo only. The filter is "filter=demo"
2. Group on tags such as $namespace, sim-cloud, sim-region, and app
3. Logical groupings are $namespace then sim-cloud, $namespace then sim-cloud then sim-region, sim-account then app

## Demo & POV

### Demo
Have this application up and running. Then start from the App Visibility pane and cover the following.
1. Flow Visibility: Green flows permitted, red flows denied, flows have direction
2. Workload Identity: Show a workload identity (Cloud Provider, Cloud Account, Cloud Region, Cloud VPC, K8S, etc)
3. Show Ruleset and explain
4. Return to visibility and show that flows have matching policy
5. Show logging: Demo search, talk about time window, etc
6. Show namespaces: Drop down in namespace tree and then back up
7. Demo K8S namespace to Prisma namespace mapping

### POV
1. Deploy enforcer(s) on K8S cluster
2. Deploy this application with no policy (learning mode)
3. Observe dotted flows from workloads to Kube-DNS
4. Create Kube-DNS policy
5. Observe DNS dotted flows transitioning to solid
6. Observe dotted flows from workloads to workloads (application)
8. Create policy for application
9. Observe application dotted flows transitioning to solid
10. Disable learning mode
11. Run scripts to generate rouge traffic
12. Observe flows are denied
13. Policy should be "default deny"
14. Wait for denied flows to age out (5 minutes)
15. Create SecOPS policy to restrict simulated account 10 to 30 (sim-account=10 to sim-account=30)
16. Observe flows are denied
17. Check that policy is "SecOPS"

![App](images/app.png)
